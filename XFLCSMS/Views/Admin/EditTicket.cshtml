@model XFLCSMS.Models.Issue.MakerView;
@{
    Layout = "_Layout";
}


<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Edit Ticket</h1>
            </div>

        </div>
    </div><!-- /.container-fluid -->
</section>

<!-- Main content -->
<section class="content">
    <form asp-action="EditTicketttt" asp-controller="Admin" name="files" method="post" enctype="multipart/form-data" id="uploadForm">
        <div class="container-fluid">
            <div class="row">
                <!-- left column -->
                <div class="col-md-6">
                    <!-- general form elements -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">General Information</h3>
                        </div>
                        <!-- /.card-header -->
                        <!-- form start -->
                        <div class="card-body">
                            <div class="form-group">
                                <label for="exampleInputEmail1">Created On</label>
                                <input type="text" asp-for="@Model.CreatedOn" class="form-control" id="exampleInputEmail1" placeholder="Created On" readonly>
                            </div>

                            <div class="form-group">
                                <label for="exampleInputEmail1">Created By</label>
                                <input type="text" asp-for="CreatedBy" class="form-control" id="exampleInputEmail1" placeholder="Created By" readonly>
                            </div>

                            <div class="form-group">
                                <label for="exampleInputEmail1">Approved On</label>
                                <input type="text" value="@Model.ApproveOn" class="form-control" id="exampleInputEmail1" placeholder="Approved On" readonly>
                            </div>

                            <div class="form-group">
                                <label for="exampleInputEmail1">Approved By</label>
                                <input type="text" value="@Model.ApproveBy" class="form-control" id="exampleInputEmail1" placeholder="Approved By" readonly>
                            </div>

                            <div class="form-group">
                                <label for="exampleInputEmail1">Assigned On</label>
                                <input type="text" value="@Model.AssgnOn" class="form-control" id="exampleInputEmail1" placeholder="Assigned On" readonly>
                            </div>

                            @*                                         <div class="form-group">
                            <label for="exampleInputEmail1">Assigned To</label>
                            <input type="text" value="@Model.AssgnBy" class="form-control" id="exampleInputEmail1" placeholder="Assigned By" readonly>

                            </div> *@
                            <div class="form-group">
                                <label for="exampleInputEmail1">Assigned To</label>
                                @* <input type="text" asp-for = "@Model.AssgnBy" class="form-control" id="exampleInputEmail1" placeholder="Assigned By" readonly> *@
                                <select asp-for="@Model.AssgnBy" id="brokerageCodes" name="AssgnBy" class="form-control">
                                    @* <option value="@Model.AssgnBy">Select a support Engineer</option> *@
                                    <option value="">Unassign</option>
                                    @foreach (var item in @Model.SupportEngineers)
                                    {
                                        <option value="@item.FullName">@item.FullName</option>
                                    }
                                </select>
                            </div>


                            <input type="hidden" asp-for="@Model.IssueId" class="form-control" id="exampleInputEmail1" placeholder="Created By" readonly>

                        </div>
                        <!-- /.card-body -->

                    </div>
                    <!-- /.card -->
                </div>
                <!--/.col (left) -->
                <!-- right column -->
                <div class="col-md-6">
                    <!-- Form Element sizes -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Information Regarding Issue</h3>
                        </div>

                        <div class="card-body">

                            <div class="form-group">
                                <label for="exampleInputEmail1">Support Type</label>
                                <input type="text" asp-for="@Model.SupportType" class="form-control" id="exampleInputEmail1" placeholder="Support Type" readonly>
                            </div>

                            <div class="form-group">
                                <label for="exampleInputEmail1">Support Category</label>
                                <input type="text" asp-for="@Model.SupportCatagory" class="form-control" id="exampleInputEmail1" placeholder="Support Category" readonly>
                            </div>

                            <div class="form-group">
                                <label for="exampleInputEmail1">Support Sub-Category</label>
                                <input type="text" asp-for="@Model.SupportSubCatagory" class="form-control" id="exampleInputEmail1" placeholder="Support Sub-Category" readonly>
                            </div>

                            <div class="form-group">
                                <label for="exampleInputEmail1">Affected Section</label>
                                <input type="text" asp-for="@Model.AffectedSection" class="form-control" id="exampleInputEmail1" placeholder="Affected Section" readonly>
                            </div>

                            <div class="form-group">
                                <label for="exampleInputEmail1">Priority</label>
                                <select asp-for="@Model.Priority" id="brokerageCodes" name="Priority" placeholder="@Model.Priority" class="form-control">
                                    @* <input type="text" asp-for="@Model.Priority" value="@Model.Priority" class="form-control" id="Priority" placeholder="Priority" readonly> *@
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>

                                </select>
                            </div>


                            <div class="form-group">
                                <label for="exampleInputEmail1">Ticket Status</label>
                                <select asp-for="@Model.IStatus" id="brokerageCodes" name="IStatus" class="form-control">
                                    <option value="Open">Open</option>
                                    <option value="Inqueue">Inqueue</option>
                                    <option value="Inprogress">In Progress</option>
                                    <option value="Close">Close</option>
                                </select>
                            </div>


                        </div>


                        <!-- /.card-body -->
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
            </div>




            <div class="container-fluid">
                <div class="card-body">
                    <div class="form-group">
                        <label>Issue Title</label>
                        <input asp-for="@Model.IssueTitle" type="text" class="form-control" id="ITitle" placeholder="Please enter an Issue Title">
                        <div id="ITitleError" class="error" style="display:none;">Please enter an Issue Title.</div>
                    </div>
                    <div>
                        <label>Issue Details</label>
                        <textarea asp-for="@Model.TicketDetails" id="editor"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Comments Regarding Issue</label>
                        <textarea asp-for="@Model.Command" class="form-control" rows="3" placeholder="Enter Comments (If any)..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Upload Files (Multiple-If required)</label>
                        <div id="fileInputsContainer">
                            <button type="button" class="btn btn-outline-success mt-3" onclick="addFileInput()">Add Files(+)</button>
                        </div>
                    </div>

                </div>
            </div>
            <div class="card-body">
                <label>Attached Files</label>
                <div class="row">
                    <div class="col-12">
                        @if (Model.Attachments.Count != 0)
                        {
                            <ul class="list-group">
                                @foreach (var item in Model.Attachments)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        @item.FileName
                                        <div>
                                            <a href="@Url.Action("DownloadAttachment", "Admin", new { att = item.AttachmentId })" class="btn btn-outline-success">Download</a>
                                            @* <button class="btn btn-outline-danger delete-btn" type="button">&times; Delete</button> *@
                                            <button class="btn btn-outline-danger delete-btn" type="button" data-attachment-id="@item.AttachmentId">&times; Delete</button>

                                        </div>
                                    </li>
                                }

                            </ul>
                        }
                        else
                        {
                            <p>No Attachment found</p>
                        }


                    </div>
                </div>


            </div>
            <div>
                <br />
                <input type="submit" value="Submit" class="btn btn-primary mb-3 " />
            </div>



        </div>
    </form>
</section>

  

@section Scripts{

    <script>
        function addFileInput() {
            var fileInputsContainer = document.getElementById("fileInputsContainer");
            var fileInputContainer = document.createElement("div");
            var newFileInput = document.createElement("input");
            var deleteButton = document.createElement("button");

            var uniqueId = "fileInput_" + new Date().getTime(); // Generate a unique ID

            newFileInput.type = "file";
            newFileInput.className = "form-control mt-3";
            newFileInput.name = "files"; // Remove '[]' to send files as a list
            newFileInput.id = uniqueId; // Set the unique ID
            newFileInput.addEventListener("change", function () {
                if (!validateFileType(this)) {
                    fileInputsContainer.removeChild(fileInputContainer);
                    alert('Invalid file type! Only TXT, DOC, PDF, JPG, and PNG files are allowed.');
                    return;
                }
                updateFileList();
            });

            deleteButton.type = "button";
            deleteButton.className = "btn btn-danger mt-2";
            deleteButton.textContent = "Delete";
            deleteButton.addEventListener("click", function () {
                fileInputsContainer.removeChild(fileInputContainer);
                updateFileList();
            });

            fileInputContainer.appendChild(newFileInput);
            fileInputContainer.appendChild(deleteButton);
            fileInputsContainer.appendChild(fileInputContainer);
            updateFileList();
        }

        function validateFileType(input) {
            var allowedExtensions = ['txt', 'doc', 'pdf', 'jpg', 'png'];
            var fileName = input.value.toLowerCase();
            var fileExtension = fileName.split('.').pop();
            return allowedExtensions.includes(fileExtension);
        }

        function updateFileList() {
            var fileInputs = document.querySelectorAll("input[type='file']");
            var fileListContainer = document.getElementById("fileList");

            if (!fileListContainer) {
                fileListContainer = document.createElement("div");
                fileListContainer.id = "fileList";
                document.getElementById("uploadForm").appendChild(fileListContainer);
            }

            fileListContainer.innerHTML = "";

            var fileListText = "<strong>Selected Files:</strong><ul>";

            fileInputs.forEach(function (fileInput) {
                for (var i = 0; i < fileInput.files.length; i++) {
                    fileListText += "<li>" + fileInput.files[i].name + "</li>";
                }
            });

            fileListText += "</ul>";
            fileListContainer.innerHTML = fileListText;
        }
    </script>






    <script>
        function validateForm() {
            var priority = document.getElementById("prioritySelect").value;
            var issueTitle = document.getElementById("ITitle").value.trim();

            var priorityError = document.getElementById("priorityError");
            var issueTitleError = document.getElementById("ITitleError");
            var submitButton = document.getElementById("submitButton");

            var priorityIsValid = priority !== "";
            var issueTitleIsValid = issueTitle !== "";

            if (!priorityIsValid) {
                priorityError.style.display = "block";
                priorityError.innerText = "Please select a priority";
                priorityError.classList.add("error");
            } else {
                priorityError.style.display = "none";
                priorityError.innerText = "";
                priorityError.classList.remove("error");
            }

            if (!issueTitleIsValid) {
                issueTitleError.style.display = "block";
                issueTitleError.innerText = "Please enter an issue title";
                issueTitleError.classList.add("error");
            } else {
                issueTitleError.style.display = "none";
                issueTitleError.innerText = "";
                issueTitleError.classList.remove("error");
            }

            submitButton.disabled = !(priorityIsValid && issueTitleIsValid);
        }

        document.getElementById("prioritySelect").addEventListener("change", validateForm);
        document.getElementById("ITitle").addEventListener("input", validateForm);
    </script>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function () {
            $(".delete-btn").on("click", function () {
                var attachmentId = $(this).data("attachment-id");
                var listItem = $(this).closest("li"); // Get the parent list item

                if (confirm("Are you sure you want to delete this attachment?")) {
                    $.ajax({
                        url: "/Admin/DeleteAttachment",
                        type: "POST",
                        data: { attachmentId: attachmentId },
                        success: function () {
                            // Handle success, such as updating UI
                            listItem.remove(); // Remove the deleted item from the list
                            alert("Attachment deleted successfully.");
                        },
                        error: function () {
                            // Handle error
                            alert("Error deleting attachment.");
                        }
                    });
                }
            });
        });
    </script>


}








